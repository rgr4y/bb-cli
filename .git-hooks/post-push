#!/bin/sh
# Mirror pushes between origin and bitbucket.
# $1 = remote name that was just pushed to. Stdin = refspecs (ignored here).
# We only mirror between our two remotes; upstream is never auto-pushed.

PUSHED_TO="$1"
MIRROR_REMOTES="origin bitbucket"

# Collect the branch refs that were pushed (one per line: <local-ref> <local-sha> <remote-ref> <remote-sha>)
REFS=""
while IFS= read -r line; do
    local_ref=$(echo "$line" | awk '{print $1}')
    remote_ref=$(echo "$line" | awk '{print $3}')
    # Skip deletions and symbolic refs
    case "$local_ref" in
        refs/heads/*) REFS="$REFS $remote_ref" ;;
    esac
done

if [ -z "$REFS" ]; then
    exit 0
fi

for remote in $MIRROR_REMOTES; do
    [ "$remote" = "$PUSHED_TO" ] && continue
    # Check the remote exists
    git remote get-url "$remote" >/dev/null 2>&1 || continue

    echo "  [post-push] Mirroring to $remote..."
    for ref in $REFS; do
        branch="${ref#refs/heads/}"
        git push "$remote" "HEAD:$branch" 2>&1 | sed 's/^/    /'
    done
done
