#!/usr/bin/env php
<?php

require_once __DIR__.'/../src/utils/helpers.php';
require_once __DIR__.'/../src/Base.php';
require_once __DIR__.'/../src/Actions/Git.php';

const APP_VERSION = '#APP_VERSION#';

// When invoked as a git credential helper, handle the git credential protocol directly.
if (basename($argv[0]) === 'git-credential-bb') {
    \BBCli\BBCli\Actions\Git::handleCredentialProtocol($argv[1] ?? 'get');
}

if (version_compare(phpversion(), '7.0.0') < 0) {
    o('Your PHP version must be equal or higher than "7.0.0" to use bb-cli', 'red');
    o('PHP version: '.phpversion(), 'yellow');
    exit(1);
}

$requiredExtensions = [
    'json',
    'curl',
    'mbstring',
];

if ($missingExtensions = array_diff($requiredExtensions, get_loaded_extensions())) {
    o('PHP extensions is incomplete. Required installing:', 'red');
    o($missingExtensions, 'yellow');
    exit(1);
}

$actionsFolder = __DIR__.'/../src/Actions';
foreach (scandir($actionsFolder) as $file) {
    if (substr($file, -4) === '.php') {
        require_once "{$actionsFolder}/{$file}";
    }
}

$actions = [
    'pr'       => \BBCli\BBCli\Actions\Pr::class,
    'pipeline' => \BBCli\BBCli\Actions\Pipeline::class,
    'branch'   => \BBCli\BBCli\Actions\Branch::class,
    'auth'     => \BBCli\BBCli\Actions\Auth::class,
    'browse'   => \BBCli\BBCli\Actions\Browse::class,
    'upgrade'  => \BBCli\BBCli\Actions\Upgrade::class,
    'env'      => \BBCli\BBCli\Actions\Env::class,
    'git'      => \BBCli\BBCli\Actions\Git::class,
    'install'  => \BBCli\BBCli\Actions\Install::class,
];

$staticCommands = [
    'help'         => ['help', '--help', '-h'],
    'version'      => ['version', '--version', '-v'],
    'autocomplete' => ['autocomplete', '--autocomplete'],
];

// ANSI color palette — defined in src/utils/helpers.php::ansi()
$c = ansi();

// Check for --project and --json arguments and extract them
$projectUrl = null;
$filteredArgv = [];
for ($i = 0; $i < count($argv); $i++) {
    if ($argv[$i] === '--project' && isset($argv[$i + 1])) {
        $projectUrl = $argv[$i + 1];
        $i++;
    } elseif ($argv[$i] === '--json') {
        $GLOBALS['BB_JSON_MODE']   = true;
        $GLOBALS['BB_JSON_OUTPUT'] = [];
    } else {
        $filteredArgv[] = $argv[$i];
    }
}
$argv = $filteredArgv;

if ($projectUrl) {
    $GLOBALS['bb_cli_project_url'] = $projectUrl;
}

if (!empty($GLOBALS['BB_JSON_MODE'])) {
    register_shutdown_function(function () {
        $out = $GLOBALS['BB_JSON_OUTPUT'];
        // If every entry is an associative array (single object commands like view),
        // unwrap the outer array so the output is a single object, not [[...]].
        if (count($out) === 1) {
            $out = $out[0];
        }
        echo json_encode($out, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)."\n";
    });
}

$userBaseAction = $argv[1] ?? null;

// Help data — command descriptions, colors (references $c), and subcommand docs
$commandHelp = [
    'auth' => [
        'desc'  => 'Manage Bitbucket credentials',
        'color' => $c['cyan'],
        'subs'  => [
            ['token', 'Save API token credentials (recommended)'],
            ['save',  'Save app password credentials (legacy)'],
            ['show',  'Show current auth config'],
        ],
    ],
    'branch' => [
        'desc'  => 'Work with branches',
        'color' => $c['green'],
        'subs'  => [
            ['list',        'List all branches'],
            ['user <name>', 'Filter branches by commit author'],
            ['name <str>',  'Filter branches by name'],
        ],
    ],
    'pr' => [
        'desc'  => 'Pull request management',
        'color' => $c['blue'],
        'subs'  => [
            ['list [dest]',             'List open PRs, optionally filtered by destination'],
            ['view <id>',               'Show PR detail: title, state, reviewers, link'],
            ['diff <id>',               'Show PR diff'],
            ['files <id>',              'List files changed in PR'],
            ['commits <id>',            'List commits in PR'],
            ['create <to> [from]',      'Create PR (defaults to current branch)'],
            ['approve <id>',            'Approve a PR (0 = approve all)'],
            ['no-approve <id>',         'Remove approval'],
            ['request-changes <id>',    'Request changes on PR'],
            ['no-request-changes <id>', 'Remove request-changes'],
            ['decline <id>',            'Decline / close a PR'],
            ['merge <id>',              'Merge a PR'],
        ],
    ],
    'pipeline' => [
        'desc'  => 'Pipeline status and control',
        'color' => $c['slate'],
        'subs'  => [
            ['latest',                 'Show latest pipeline'],
            ['get <id>',               'Show pipeline details'],
            ['wait [id]',              'Wait for pipeline to complete'],
            ['run <branch>',           'Run default pipeline on branch'],
            ['custom <branch> <name>', 'Run custom pipeline on branch'],
        ],
    ],
    'env' => [
        'desc'  => 'Deployment environment variables',
        'color' => $c['yellow'],
        'subs'  => [
            ['list',                                'List environments'],
            ['variables <env-uuid>',                'List variables for environment'],
            ['create-variable <env> <k> <v>',       'Create a variable'],
            ['update-variable <env> <var> <k> <v>', 'Update a variable'],
        ],
    ],
    'browse' => [
        'desc'  => 'Open repository in browser',
        'color' => $c['cyan'],
        'subs'  => [
            ['browse', 'Open repo in browser (default)'],
            ['show',   'Print repo URL'],
        ],
    ],
    'git' => [
        'desc'  => 'Git credential helper setup',
        'color' => $c['red'],
        'subs'  => [
            ['setup',  'Install credential helper for Bitbucket (auto-auth for git)'],
            ['remove', 'Uninstall credential helper'],
        ],
    ],
    'install' => [
        'desc'  => 'Install bb to PATH',
        'color' => $c['gray'],
        'subs'  => [
            ['install', 'Copy bb binary to ~/.local/bin (or first writable PATH dir)'],
        ],
    ],
    'upgrade' => [
        'desc'  => 'Self-update bb-cli',
        'color' => $c['gray'],
        'subs'  => [
            ['upgrade', 'Check for and install latest release from GitHub'],
        ],
    ],
];

// Print version
if (in_array($userBaseAction, $staticCommands['version'])) {
    o('Version: '.APP_VERSION, 'green');
    exit(0);
}

// Print global help
if (is_null($userBaseAction) || in_array($userBaseAction, $staticCommands['help'])) {
    $R = $c['R'];

    echo "\n";
    echo $c['bold'].$c['cyan'];
    echo "  ██████╗ ██████╗      ██████╗██╗     ██╗\n";
    echo "  ██╔══██╗██╔══██╗    ██╔════╝██║     ██║\n";
    echo "  ██████╔╝██████╔╝    ██║     ██║     ██║\n";
    echo "  ██╔══██╗██╔══██╗    ██║     ██║     ██║\n";
    echo "  ██████╔╝██████╔╝    ╚██████╗███████╗██║\n";
    echo "  ╚═════╝ ╚═════╝      ╚═════╝╚══════╝╚═╝\n";
    echo $R;
    echo $c['gray']."  Bitbucket CLI  ".$c['dim']."v".APP_VERSION.$R."  ".$c['gray']."·  bitbucket.org\n".$R;
    echo "\n";

    echo $c['bold'].$c['white']."  USAGE".$R."\n";
    echo "    ".$c['cyan']."bb".$R." ".$c['yellow']."<command>".$R." ".$c['gray']."[subcommand] [args] [--project owner/repo]\n".$R;
    echo "\n";

    echo $c['bold'].$c['white']."  COMMANDS\n".$R;
    echo "\n";

    $separators = [
        "·:·:· bb-cli ·:·:·",
        "=-[ bb-cli ]=-",
        "»»· bb-cli ·««",
        "·····[ bb-cli ]·····",
        "──< bb-cli >──",
        "-=[ bb-cli ]=-",
        "~*~ bb-cli ~*~",
        "·[ bb-cli ]·",
    ];
    $sep = $separators[array_rand($separators)];
    $sepLine = $c['dim'].$c['gray'].str_pad(
        $sep,
        120,
        str_repeat('·', 60),
        STR_PAD_BOTH
    ).$R;

    $first = true;
    foreach ($commandHelp as $cmd => $info) {
        if (!$first) {
            echo "  ".$sepLine."\n";
        }
        $first = false;

        echo "    ".$c['bold'].$info['color'].$cmd.$R;
        echo str_repeat(' ', max(1, 12 - strlen($cmd)));
        echo $c['white'].$info['desc'].$R."\n";

        foreach ($info['subs'] as [$sub, $subDesc]) {
            echo "      ".$c['gray'].$sub.$R;
            echo str_repeat(' ', max(1, 30 - strlen($sub)));
            echo $c['dim'].$subDesc.$R."\n";
        }
    }
    echo "\n";

    echo $c['bold'].$c['white']."  GLOBAL OPTIONS\n".$R;
    echo "\n";
    echo "    ".$c['yellow']."--project".$R." ".$c['gray']."<owner/repo>".$R;
    echo str_repeat(' ', 10);
    echo $c['dim']."Target a remote repo instead of local git context\n".$R;
    echo "    ".$c['yellow']."--json".$R;
    echo str_repeat(' ', 23);
    echo $c['dim']."Output structured JSON (useful for scripting / LLMs)\n".$R;
    echo "    ".$c['yellow']."--help".$R.", ".$c['yellow']."-h".$R;
    echo str_repeat(' ', 20);
    echo $c['dim']."Show help (global or per-command)\n".$R;
    echo "    ".$c['yellow']."--version".$R.", ".$c['yellow']."-v".$R;
    echo str_repeat(' ', 18);
    echo $c['dim']."Show version\n".$R;
    echo "\n";

    echo $c['bold'].$c['white']."  EXAMPLES\n".$R;
    echo "\n";
    $examples = [
        ["bb auth token",                 "Set up API token authentication"],
        ["bb git setup",                  "Configure git to auto-auth with your token"],
        ["bb pr list",                    "List open PRs in current repo"],
        ["bb pr create main",             "Open PR from current branch → main"],
        ["bb branch user rob",            "Branches with Rob's commits"],
        ["bb pr list --project org/repo", "PRs in a remote repo"],
    ];
    foreach ($examples as [$ex, $desc]) {
        echo "    ".$c['cyan'].$ex.$R;
        echo str_repeat(' ', max(1, 42 - strlen($ex)));
        echo $c['dim'].$desc.$R."\n";
    }
    echo "\n";
    exit(0);
}

// Print autocomplete
if (in_array($userBaseAction, $staticCommands['autocomplete'])) {
    echo implode(' ', array_keys($actions));
    exit(0);
}

if (!isset($actions[$userBaseAction])) {
    o("Unknown command: {$userBaseAction}", 'red');
    echo $c['gray']."  Commands: ".$c['R'];
    echo $c['cyan'].implode($c['gray'].", ".$c['cyan'], array_keys($actions)).$c['R'];
    echo "\n".$c['gray']."  Run ".$c['yellow']."bb --help".$c['gray']." for full usage.".$c['R']."\n\n";
    exit(1);
}

$actionClass = new $actions[$userBaseAction]();
$userAction = $argv[2] ?? null;

// Print per-command help
if (in_array($userAction, $staticCommands['help'])) {
    $R = $c['R'];

    $subHelp = $commandHelp[$userBaseAction]['subs'] ?? [];
    $subByAlias = [];
    foreach ($subHelp as [$sub, $desc]) {
        $subByAlias[trim(explode(' ', $sub)[0])] = $desc;
    }

    echo "\n";
    echo "  ".$c['bold'].$c['cyan']."bb ".$userBaseAction.$R;
    if (isset($commandHelp[$userBaseAction]['desc'])) {
        echo "  ".$c['dim'].$commandHelp[$userBaseAction]['desc'].$R;
    }
    echo "\n\n";

    echo "  ".$c['bold'].$c['white']."SUBCOMMANDS".$R."\n\n";

    foreach ($actionClass::AVAILABLE_COMMANDS as $method => $aliases) {
        $aliasParts = array_map('trim', explode(',', $aliases));
        $primary    = $aliasParts[0];
        $rest       = array_slice($aliasParts, 1);

        echo "    ".$c['cyan'].$primary.$R;
        if ($rest) {
            echo "  ".$c['gray']."(".implode(', ', $rest).")".$R;
        }

        $desc = $subByAlias[$primary] ?? '';
        if ($desc) {
            $padLen = max(1, 24 - strlen($primary) - ($rest ? 4 + strlen(implode(', ', $rest)) : 0));
            echo str_repeat(' ', $padLen).$c['dim'].$desc.$R;
        }
        echo "\n";
    }
    echo "\n";
    exit(0);
}

// Print autocomplete for action
if (in_array($userAction, $staticCommands['autocomplete'])) {
    $actionClass->listCommandsForAutocomplete();
    exit(0);
}

// Check if git folder exists (skip if --project is used)
if ($actionClass::CHECK_GIT_FOLDER && !$projectUrl) {
    if (!is_dir(getcwd().'/.git')) {
        o('ERROR: No git repository found in current directory.', 'red');
        o('Use --project "owner/repo" to work with remote repository.', 'yellow');
        exit(1);
    }
}

$classMethodToCall = $actionClass::DEFAULT_METHOD;

if (!is_null($userAction)) {
    $classMethodToCall = $actionClass->getMethodNameFromAlias($userAction);
}

if ($classMethodToCall === false) {
    o("Unknown method ", 'red', '', "\033[0m");
    o("{$argv[2]}", 'cyan', '', "\033[0m");
    o(" for ", 'red', '', "\033[0m");
    o("{$userBaseAction}", 'cyan', '', "\033[0m");
    o(" action.", 'red');
    exit(1);
}

try {
    call_user_func_array(
        [$actionClass, $classMethodToCall],
        array_slice($argv, 3)
    );
} catch (\Throwable $e) {
    if (strpos($e->getMessage(), 'Too few arguments') !== false) {
        o('Too few arguments.', 'red');
    } else {
        o($e->getMessage(), 'red');
    }

    exit(1);
}
